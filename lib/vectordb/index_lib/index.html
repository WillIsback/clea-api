<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://WillIsback.github.io/clea-api/lib/vectordb/index_lib/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Indexation vectorielle - Cléa-API Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../../css/mkdocsoad.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Indexation vectorielle";
        var mkdocs_page_input_path = "lib/vectordb/index_lib.md";
        var mkdocs_page_url = "/clea-api/lib/vectordb/index_lib/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Cléa-API Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Accueil</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../main/">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../database/">Base de données</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../schemas/">Schémas</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Documentation des librairies</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >askai</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../askai/rag_lib/">RAG</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >doc_loader</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../doc_loader/extractor_lib/">Extracteurs</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../doc_loader/splitter_lib/">Segmentation</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >pipeline</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../pipeline/pipeline_lib/">Pipeline end-to-end</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >vectordb</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../crud_lib/">Opérations CRUD</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Indexation vectorielle</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#installation">Installation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#table-des-matieres">Table des matières</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#1-create_simple_indexcorpus_id-str-dict">1. create_simple_index(corpus_id: str) → dict</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-drop_indexcorpus_id-str-dict">2. drop_index(corpus_id: str) → dict</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-check_index_statuscorpus_id-str-dict">3. check_index_status(corpus_id: str) → dict</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-check_all_indexes-dict">4. check_all_indexes() → dict</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#5-clean_orphaned_indexes-dict">5. clean_orphaned_indexes() → dict</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#6-schedule_cleanup_jobinterval_hours-int-24-none">6. schedule_cleanup_job(interval_hours: int = 24) → None</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#logging-erreurs">Logging &amp; erreurs</a>
    </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../stats/stats_computer_lib/">Recherche hybride</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >stats</a>
    <ul>
                <li class="toctree-l2"><a class="" href="../../stats/stats_lib.md">Statistiques</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Références API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >REST API</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../../api/rest/rest_api/">Documentation Swagger</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Références Python</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >askai</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/askai/rag_references/">RAG</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >doc_loader</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/doc_loader/extractor_references/">Extracteurs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/doc_loader/splitter_references/">Segmentation</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >pipeline</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/pipeline/pipeline_references/">Pipeline</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >vectordb</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/vectordb/crud_references/">CRUD</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/vectordb/index_references/">Indexation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/vectordb/search_references/">Recherche</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >stats</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../api/lib/stats/stats_computer_references/">Statistiques</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Intégrations</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >JavaScript / TypeScript</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >askai</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/askai/rag_js/">RAG</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >doc_loader</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/doc_loader/doc_loader_js/">Extraction de documents</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >pipeline</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/pipeline/pipeline_js/">Pipeline end-to-end</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >vectordb</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/vectordb/crud_js/">Opérations CRUD</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/vectordb/index_js/">Indexation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/vectordb/search_js/">Recherche</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >stats</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../../Integration/stats/stats_computer_js/">Statistiques</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Cléa-API Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Documentation des librairies</li>
          <li class="breadcrumb-item">vectordb</li>
      <li class="breadcrumb-item active">Indexation vectorielle</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/WillIsback/clea-api/edit/master/docs/lib/vectordb/index_lib.md">Edit on Cléa-API</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="module-index_manager">Module <code>index_manager</code></h1>
<p>Gestion des index vectoriels pour pgvector au sein de <strong>Cléa-API</strong>.<br />
Ce module offre une API simple pour créer, supprimer et contrôler l'état des index IVFFLAT associés aux chunks de documents.</p>
<hr />
<h2 id="installation">Installation</h2>
<p>Le module <code>index_manager</code> fait partie du package <code>vectordb</code>.<br />
Aucun paquet externe n'est nécessaire, si ce n'est votre installation PostgreSQL/pgvector et SQLAlchemy.</p>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>vectordb
</code></pre></div>
<hr />
<h2 id="table-des-matieres">Table des matières</h2>
<ol>
<li><a href="#create_simple_index">Créer un index simple</a></li>
<li><a href="#drop_index">Supprimer un index</a></li>
<li><a href="#check_index_status">Vérifier l'état d'un index</a></li>
<li><a href="#check_all_indexes">Vérifier tous les index</a></li>
<li><a href="#clean_orphaned_indexes">Nettoyer les index orphelins</a></li>
<li><a href="#schedule_cleanup_job">Programmation du nettoyage automatique</a></li>
</ol>
<hr />
<p><a name="create_simple_index"></a></p>
<h2 id="1-create_simple_indexcorpus_id-str-dict">1. <code>create_simple_index(corpus_id: str) → dict</code></h2>
<p>Crée un index <strong>IVFFLAT</strong> standard sur une vue matérialisée des chunks appartenant au corpus.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_simple_index</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">create_simple_index</span><span class="p">(</span><span class="s2">&quot;3159e84e-9dc6-41a7-a464-bb6c3894a5ad&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Paramètre</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>corpus_id</code></td>
<td><code>str</code></td>
<td>UUID du corpus à indexer (avec tirets).</td>
</tr>
</tbody>
</table>
<p><strong>Retourne</strong> un dictionnaire comportant :</p>
<ul>
<li><code>status</code>: <code>"success"</code>, <code>"exists"</code> ou <code>"error"</code>.</li>
<li><code>message</code>: message human-readable.</li>
<li>
<p>Sur succès :</p>
</li>
<li>
<p><code>index_type</code>: toujours <code>"ivfflat"</code>.</p>
</li>
<li><code>lists</code>: nombre de listes utilisées pour IVFFLAT.</li>
<li><code>documents_updated</code>: nombre de documents flagués <code>index_needed=False</code>.</li>
<li><code>view_name</code>: nom de la vue matérialisée créée.</li>
</ul>
<details>
<summary>Exemple de sortie</summary>

<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Index vectoriel créé pour 123 chunks dans le corpus 3159e84e-9dc6-41a7-a464-bb6c3894a5ad&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;index_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ivfflat&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;lists&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;documents_updated&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;view_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;temp_corpus_chunks_3159e84e_9dc6_41a7_a464_bb6c3894a5ad&quot;</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<p><a name="drop_index"></a></p>
<h2 id="2-drop_indexcorpus_id-str-dict">2. <code>drop_index(corpus_id: str) → dict</code></h2>
<p>Supprime l'index et la vue matérialisée correspondant au corpus.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">drop_index</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">drop_index</span><span class="p">(</span><span class="s2">&quot;3159e84e-9dc6-41a7-a464-bb6c3894a5ad&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Paramètre</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>corpus_id</code></td>
<td><code>str</code></td>
<td>UUID du corpus dont on veut supprimer l'index.</td>
</tr>
</tbody>
</table>
<p><strong>Retourne</strong> :</p>
<ul>
<li><code>status</code>: <code>"success"</code>, <code>"warning"</code> (si l'index n'existait pas) ou <code>"error"</code>.</li>
<li><code>message</code>: explication de l'opération.</li>
</ul>
<details>
<summary>Exemple de sortie</summary>

<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Index idx_vector_3159e84e_9dc6_41a7_a464_bb6c3894a5ad et vue temp_corpus_chunks_3159e84e_9dc6_41a7_a464_bb6c3894a5ad supprimés avec succès&quot;</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<p><a name="check_index_status"></a></p>
<h2 id="3-check_index_statuscorpus_id-str-dict">3. <code>check_index_status(corpus_id: str) → dict</code></h2>
<p>Récupère l'état courant de l'index vectoriel pour un corpus donné.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_index_status</span>

<span class="n">status</span> <span class="o">=</span> <span class="n">check_index_status</span><span class="p">(</span><span class="s2">&quot;3159e84e-9dc6-41a7-a464-bb6c3894a5ad&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Paramètre</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>corpus_id</code></td>
<td><code>str</code></td>
<td>UUID du corpus.</td>
</tr>
</tbody>
</table>
<p><strong>Retourne</strong> un objet contenant :</p>
<ul>
<li><code>corpus_id</code> : UUID interrogé.</li>
<li><code>index_exists</code> : booléen, l'index existe-t-il en base ?</li>
<li><code>config_exists</code> : booléen, la config Pydantic/SQLAlchemy existe-t-elle ?</li>
<li><code>is_indexed</code> : booléen, l'index est-il actif selon la config ?</li>
<li><code>index_type</code> : <code>"ivfflat"</code> ou <code>"hnsw"</code> ou <code>null</code>.</li>
<li><code>chunk_count</code> : nombre total de chunks dans le corpus.</li>
<li><code>indexed_chunks</code> : nombre de chunks réellement indexés (config).</li>
<li><code>last_indexed</code> : date du dernier indexe (<code>datetime</code>) ou <code>null</code>.</li>
</ul>
<details>
<summary>Exemple de sortie</summary>

<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;corpus_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3159e84e-9dc6-41a7-a464-bb6c3894a5ad&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;index_exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;config_exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;is_indexed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;index_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ivfflat&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;chunk_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;indexed_chunks&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;last_indexed&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-05-02T14:23:10.123456&quot;</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<p><a name="check_all_indexes"></a></p>
<h2 id="4-check_all_indexes-dict">4. <code>check_all_indexes() → dict</code></h2>
<p>Balaye tous les corpus en base et renvoie l'état de leurs index.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_all_indexes</span>

<span class="n">all_status</span> <span class="o">=</span> <span class="n">check_all_indexes</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_status</span><span class="p">)</span>
</code></pre></div>
<p><strong>Retourne</strong> :</p>
<ul>
<li><code>status</code>: <code>"success"</code> ou <code>"error"</code>.</li>
<li><code>corpus_count</code>: nombre de corpus trouvés.</li>
<li><code>indexes</code>: tableau d'objets identiques à la sortie de <code>check_index_status()</code>.</li>
</ul>
<details>
<summary>Exemple de sortie</summary>

<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;corpus_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;indexes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;corpus_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aaa111...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;index_exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;config_exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;is_indexed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;index_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ivfflat&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;chunk_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;indexed_chunks&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;last_indexed&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-05-01T09:12:34&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;corpus_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bbb222...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;index_exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;config_exists&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;is_indexed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;index_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;chunk_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;indexed_chunks&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;last_indexed&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<p><a name="clean_orphaned_indexes"></a></p>
<h2 id="5-clean_orphaned_indexes-dict">5. <code>clean_orphaned_indexes() → dict</code></h2>
<p>Nettoie les index et configurations orphelins qui ne sont plus associés à des corpus existants.</p>
<p>Cette fonction est utile pour maintenir la propreté de la base de données après la suppression de documents :
- Elle identifie les configurations d'index dont le corpus n'existe plus
- Elle supprime les vues matérialisées et index PostgreSQL associés
- Elle nettoie les entrées dans la table <code>index_configs</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_cleaner</span><span class="w"> </span><span class="kn">import</span> <span class="n">clean_orphaned_indexes</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">clean_orphaned_indexes</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<p><strong>Retourne</strong> un dictionnaire comportant :</p>
<ul>
<li><code>status</code>: <code>"success"</code>, <code>"partial_success"</code> (certaines suppressions ont échoué) ou <code>"error"</code>.</li>
<li><code>deleted_count</code>: nombre de configurations d'index supprimées.</li>
<li><code>cleaned_corpus_ids</code>: liste des identifiants de corpus nettoyés.</li>
<li><code>errors</code>: liste d'erreurs éventuelles lors du nettoyage (si <code>partial_success</code>).</li>
<li><code>timestamp</code>: horodatage de l'opération.</li>
</ul>
<details>
<summary>Exemple de sortie</summary>

<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;deleted_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cleaned_corpus_ids&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;cccc111-dddd-eeee-ffff-gggghhhhiiii&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;jjjj222-kkkk-llll-mmmm-nnnnoooooppp&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;errors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-05-05T10:30:45.123456&quot;</span>
<span class="p">}</span>
</code></pre></div>

</details>

<hr />
<p><a name="schedule_cleanup_job"></a></p>
<h2 id="6-schedule_cleanup_jobinterval_hours-int-24-none">6. <code>schedule_cleanup_job(interval_hours: int = 24) → None</code></h2>
<p>Configure un travail périodique qui nettoie automatiquement les index orphelins.</p>
<p>Cette fonction utilise APScheduler pour exécuter <code>clean_orphaned_indexes</code> à intervalles réguliers.
Elle est généralement appelée au démarrage de l'application via la lifespan FastAPI.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_cleaner</span><span class="w"> </span><span class="kn">import</span> <span class="n">schedule_cleanup_job</span>

<span class="c1"># Configurer un nettoyage toutes les 12 heures</span>
<span class="n">schedule_cleanup_job</span><span class="p">(</span><span class="n">interval_hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Paramètre</th>
<th>Type</th>
<th>Description</th>
<th>Défaut</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>interval_hours</code></td>
<td><code>int</code></td>
<td>Intervalle en heures entre nettoyages</td>
<td><code>24</code></td>
</tr>
</tbody>
</table>
<p><strong>Exemple d'intégration dans la lifespan FastAPI</strong> :</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vectordb.src.index_cleaner</span><span class="w"> </span><span class="kn">import</span> <span class="n">schedule_cleanup_job</span>

<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
    <span class="c1"># Démarrage de l&#39;application</span>
    <span class="n">schedule_cleanup_job</span><span class="p">(</span><span class="n">interval_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="c1"># Arrêt de l&#39;application - rien à faire car APScheduler s&#39;arrête automatiquement</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="logging-erreurs">Logging &amp; erreurs</h2>
<ul>
<li>Toutes les opérations journalisent en niveau <strong>INFO</strong> et <strong>WARNING</strong> via le logger standard.</li>
<li>En cas d'erreur, la transaction est roll-backée et <code>{"status":"error","message":...}</code> est retourné.</li>
<li>Le nettoyage des index orphelins génère des logs détaillés pour faciliter le suivi des opérations.</li>
</ul>
<hr />
<blockquote>
<p><em>Modules</em> : <code>vectordb/src/index_manager.py</code>, <code>vectordb/src/index_cleaner.py</code><br />
<em>Dernière mise à jour</em> : 05 mai 2025</p>
</blockquote>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../crud_lib/" class="btn btn-neutral float-left" title="Opérations CRUD"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../stats/stats_computer_lib/" class="btn btn-neutral float-right" title="Recherche hybride">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/WillIsback/clea-api" class="fa fa-code-fork" style="color: #fcfcfc"> Cléa-API</a>
        </span>
    
    
      <span><a href="../crud_lib/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../stats/stats_computer_lib/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
